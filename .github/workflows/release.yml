name: Publish Release

on:
  push:
    tags:
      - 'v*'   # run only when you push a version tag

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Enable debug logging
        run: echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Package mod
        shell: pwsh
        run: |
          $workspaceRoot = "${{ github.workspace }}"
          $repoName      = "${{ github.event.repository.name }}"
          $modName       = "mod$repoName"

          $buildRoot   = Join-Path $workspaceRoot "build"
          $zipPath     = Join-Path $workspaceRoot "$repoName.zip"
          $binPath     = Join-Path $buildRoot "bin\config\r4game\user_config_matrix\pc"
          $modPath     = Join-Path $buildRoot "mods\$modName"
          $contentPath = Join-Path $modPath "content"

          Write-Host "DEBUG: workspaceRoot is $workspaceRoot"
          Write-Host "DEBUG: repoName is $repoName"
          Write-Host "DEBUG: buildRoot is $buildRoot"
          Write-Host "DEBUG: zipPath will be $zipPath"

          # Reset build folder
          if (Test-Path $buildRoot) { Remove-Item $buildRoot -Recurse -Force }
          New-Item -Force -ItemType Directory -Path $contentPath | Out-Null

          function NotIgnored($item) {
            return ($item.FullName -notmatch '\\Ignored\\' -and $item.FullName -notmatch '\\build\\')
          }

          # Copy scripts
          Get-ChildItem "$workspaceRoot\scripts" -Recurse | Where-Object { NotIgnored $_ } | ForEach-Object {
            $dest = $_.FullName.Replace($workspaceRoot, $contentPath)
            New-Item -ItemType Directory -Force -Path (Split-Path $dest) | Out-Null
            Copy-Item $_.FullName $dest -Force
          }

          # Copy w3strings
          Get-ChildItem $workspaceRoot -Recurse -Filter *.w3strings | Where-Object { NotIgnored $_ } | ForEach-Object {
            $dest = Join-Path $contentPath $_.Name
            if ($_.FullName -ne $dest) { Copy-Item $_.FullName $dest -Force }
          }

          # Copy settings.txt
          Get-ChildItem $workspaceRoot -Recurse -Filter *.settings.txt | Where-Object { NotIgnored $_ } | ForEach-Object {
            $dest = Join-Path $modPath $_.Name
            if ($_.FullName -ne $dest) { Copy-Item $_.FullName $dest -Force }
          }

          # Copy XMLs only if they exist
          $xmlFiles = Get-ChildItem $workspaceRoot -Recurse -Filter *.xml | Where-Object { NotIgnored $_ }
          if ($xmlFiles.Count -gt 0) {
            New-Item -Force -ItemType Directory -Path $binPath | Out-Null
            $xmlFiles | ForEach-Object {
              $dest = Join-Path $binPath $_.Name
              if ($_.FullName -ne $dest) { Copy-Item $_.FullName $dest -Force }
            }
          }

          # Debug: show contents of build before compressing
          Write-Host "DEBUG: Contents of buildRoot before compress:"
          Get-ChildItem $buildRoot -Recurse | ForEach-Object { Write-Host $_.FullName }

          Compress-Archive -Path "$buildRoot\*" -DestinationPath $zipPath -Force
          Write-Host "Packaged $zipPath successfully!"

          # Export path for later steps
          "ZIP_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Echo ZIP_PATH
        run: echo "ZIP_PATH is ${{ env.ZIP_PATH }}"

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          # Use a glob so it matches any zip in the workspace
          files: '**/*.zip'