name: Release Mod

on:
  push:
    branches:
      - '**'   # run on any branch push
    tags:
      - 'v*'   # also run on version tags

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write   # allow creating releases

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Package mod
        shell: pwsh
        run: |
          $workspaceRoot = "${{ github.workspace }}"
          $repoName      = "${{ github.event.repository.name }}"
          $modName       = "mod$repoName"

          $buildRoot   = Join-Path $workspaceRoot "build"
          $zipPath     = Join-Path $workspaceRoot "$repoName.zip"   # single source of truth
          $binPath     = Join-Path $buildRoot "bin\config\r4game\user_config_matrix\pc"
          $modPath     = Join-Path $buildRoot "mods\$modName"
          $contentPath = Join-Path $modPath "content"

          if (Test-Path $buildRoot) { Remove-Item $buildRoot -Recurse -Force }
          New-Item -Force -ItemType Directory -Path $contentPath | Out-Null

          function NotIgnored($item) {
            return ($item.FullName -notmatch '\\Ignored\\' -and $item.FullName -notmatch '\\build\\')
          }

          # Copy scripts
          Get-ChildItem "$workspaceRoot\scripts" -Recurse | Where-Object { NotIgnored $_ } | ForEach-Object {
            $dest = $_.FullName.Replace($workspaceRoot, $contentPath)
            New-Item -ItemType Directory -Force -Path (Split-Path $dest) | Out-Null
            Copy-Item $_.FullName $dest -Force
          }

          # Copy w3strings
          Get-ChildItem $workspaceRoot -Recurse -Filter *.w3strings | Where-Object { NotIgnored $_ } | ForEach-Object {
            $dest = Join-Path $contentPath $_.Name
            if ($_.FullName -ne $dest) { Copy-Item $_.FullName $dest -Force }
          }

          # Copy settings.txt
          Get-ChildItem $workspaceRoot -Recurse -Filter *.settings.txt | Where-Object { NotIgnored $_ } | ForEach-Object {
            $dest = Join-Path $modPath $_.Name
            if ($_.FullName -ne $dest) { Copy-Item $_.FullName $dest -Force }
          }

          # Copy XMLs only if they exist
          $xmlFiles = Get-ChildItem $workspaceRoot -Recurse -Filter *.xml | Where-Object { NotIgnored $_ }
          if ($xmlFiles.Count -gt 0) {
            New-Item -Force -ItemType Directory -Path $binPath | Out-Null
            $xmlFiles | ForEach-Object {
              $dest = Join-Path $binPath $_.Name
              if ($_.FullName -ne $dest) { Copy-Item $_.FullName $dest -Force }
            }
          }

          Compress-Archive -Path "$buildRoot\*" -DestinationPath $zipPath -Force

          # Verify zip exists and expose path to later steps
          Write-Host "Packaged zip at: $zipPath"
          if (-not (Test-Path $zipPath)) {
            Write-Error "Zip not found at $zipPath"
            exit 1
          }
          # Export ZIP_PATH for subsequent steps
          "$([Environment]::NewLine)ZIP_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload artifact (always)
        uses: actions/upload-artifact@v4
        with:
          name: packaged-mod
          path: ${{ env.ZIP_PATH }}
          compression-level: 0

      - name: Upload release asset (only on tags)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_PATH }}